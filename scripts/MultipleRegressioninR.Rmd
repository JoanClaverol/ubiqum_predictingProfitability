---
title: 'Task 3: Multiple Regression in R'
author: "JoanClaverol_data anlayst mentor"
date: "16 de octubre de 2018"
output: 
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    code_folding: hide
---

# Task overview

Data we have: new prodcut attributes and existing product attributes

* Predicting sales of four different product types: PC, Laptops, Netbooks and Smartphones
* Assessing the impact services reviews and customer reviews have on sales of different product types

Delivery a brief report that includes the methods you employed and your results. I would also like to see the results exported from R for each of the methods. The report should contain:

1. brief summary in Word or PowerPoint of your methods and results that include:
* The algorithms you tried. 
* The algorithm you selected to make the predictions, including a rationale for selecting the method you did and the level of confidence in the predictions.
* Your sales predictions for four target product types found in the new product attributes data set
* A chart that displays the impact of customer and service reviews have on sales volume. 

2. The results of each model you constructed, exported from R

## Plan of attack

1. Dummifying variables with caret

2. Correlation and using correlation matrix to understand data

3. Create regression models using (SVM, Random forest, GBM)

4. Error analysis

# Uploading datasets

```{r loading libraries and dataset, message=FALSE, warning=F}
if(require("pacman")=="FALSE"){
  install.packages("pacman")
} 

pacman::p_load(corrplot, tidyverse, caret, dunn.test, Hmisc,xtable, htmlTable, partykit, knitr, kableExtra, dummies, mice, RColorBrewer, e1071, gbm)

ExProd <- read_csv("../data/existingproductattributes2017.2.csv")
NwProd <- read_csv("../data/newproductattributes2017.2.csv")
```

# Exploring the dataset

```{r looking for NAs}
# looking for NAs
kable(mice::md.pattern(ExProd, plot = F)) %>% kable_styling(bootstrap_options = "responsive") %>%
  scroll_box(width = "100%")
```


```{r removing best seller column}
ExProd$BestSellersRank <- NULL
```

Understanding the sales of the company: 

```{r business overview, warning=F}
# Is the volume related to the categories?

ExProd %>%
  group_by(ProductType) %>%
  summarise(Total_Volume = sum(Volume)) %>%
  arrange(desc(Total_Volume)) -> Volume_category

# Number of products by category

ExProd %>%
  group_by(ProductType) %>%
  summarise(Number_Products = n()) %>%
  arrange(desc(Number_Products)) -> NumProd_category

# Profit per category

ExProd %>%
  group_by(ProductType) %>%
  summarise(Mean_Profit_Perc = round(mean(ProfitMargin),2)) %>%
  arrange(desc(Mean_Profit_Perc)) -> Profit_category

# Show the information into one table
kable(Profit_category %>%
        left_join(NumProd_category, by = 'ProductType') %>%
        left_join(Volume_category, by = 'ProductType') %>%
        mutate(Total_Profits = Mean_Profit_Perc*Total_Volume) %>% 
        arrange(desc(Total_Profits)), col.names = c("", "Profit in %", "NÂº products", "Total Volume", "Total Profits")) %>% 
  kable_styling("responsive") %>% 
  column_spec(1, bold = T, include_thead = T) %>% 
  column_spec(5, background = "#f0f5f0")
```

## Visualizations

### Identifying outliers

```{r outliers visualization}
 # # Visualize data
# 
ExProd %>% ggplot(aes(ProductType, Volume)) + geom_boxplot(outlier.colour = "red") + 
  ggtitle("Analysing volume distribution") + theme_bw() + theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.title.x = element_blank())
ExProd %>% ggplot(aes(ProductType, x2StarReviews)) + geom_boxplot(outlier.colour = "red") + ggtitle("Analysing 2 stars reviews distribution") + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.title.x = element_blank())
ExProd %>% ggplot(aes(ProductType, x1StarReviews)) + geom_boxplot(outlier.colour = "red") + ggtitle("Analysing 1 star review distribution") + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.title.x = element_blank())

```

Table of outliers: 

```{r}
ExProd %>%
  filter(Volume > 6000 | x2StarReviews > 100 | x1StarReviews > 1500) -> outliers

kable(outliers) %>% kable_styling(bootstrap_options = "responsive") %>%
  scroll_box(width = "100%")
```

They represent the `r nrow(outliers)/nrow(ExProd)*100`% of the data. We can exclude them

```{r outliers elimination}
ExProd.clean <- ExProd %>%
  filter(!(ProductNum %in% outliers$ProductNum))
```

# Preprocess

## Feature engineering

Dumification of the variables: 

```{r creation of dummy variables}
Pred.Dummy <- dummyVars(~ .,
                        data = ExProd.clean,
                        sep = ".")

ExProd.dummy <- data.frame(predict(Pred.Dummy, newdata = ExProd))
kable(head(ExProd.dummy)) %>% kable_styling(bootstrap_options = "responsive") %>% scroll_box(width = "100%", height = "200px")
```

## Feature selection

Construction of the correlation matrix to select the relevant variables

```{r correlation matrix, fig.height=14, fig.width=18}
ex.Corr <- cor(ExProd.dummy)
corrplot(ex.Corr, method = "pie", type = "lower", order = "hclust", col = brewer.pal(n = 8, name = "RdBu"),
         number.cex = 0.70, number.digits = 2, tl.cex = 1.5, tl.srt = 5, tl.col = "black")
```

Matrix interpretation +  festure selection

* 5 stars is overfitted to Volume, we should take it out. 
* Stars 4, 3, 2 and 1 has colinearity, we decided to keep variables 4 stars and 1 stars, and take out all the rest.
* attrubutes do not have a relevant correlation with "Volume", and we decided to remove from our model: "Logistics", "ShippingWeight","ProductDepth","ProductWidth","ProductHeight", "Price","Recommendproduct"  and "Profit margin". 
* we only have to predict the sales for pc, laptop, netbook and accessories, so we will filter the rest of the dataset. 
* We keep "ProductNum" for the posterior analysis of each product 

```{r feature selection}
ExProd.clean2 <- ExProd.dummy %>% 
  filter(ProductTypeAccessories == 1 | ProductTypeLaptop == 1 | ProductTypeNetbook == 1 | ProductTypePC == 1)

productTypes.analysed <- c("ProductTypeAccessories","ProductTypeLaptop","ProductTypeNetbook","ProductTypePC")
features.corr <- c(productTypes.analysed,"ProductNum","x4StarReviews","x1StarReviews","PositiveServiceReview","NegativeServiceReview","Volume","Recommendproduct")

ExProd.selection <- ExProd.clean2 %>% 
  select(features.corr)
```

The dimensions of our samples are `r dim(ExProd.selection)`. Se how is the correation matrix after the feature selection:

```{r second correllation matrix , fig.height=14, fig.width=18}
ex.Corr2 <- cor(ExProd.selection)
corrplot(ex.Corr2, method = "pie", type = "lower", order = "hclust", col = brewer.pal(n = 8, name = "RdBu"), 
         number.cex = 0.70, number.digits = 2, tl.cex = 1.5, tl.srt = 10, tl.col = "black")
```

# Modalization 

## Creation of the training control and cross validation

```{r partions and cross validation}
# Dataset which Im using to make predictions
data <- ExProd.selection

#Train and test size
set.seed(956)
train_size <- createDataPartition(ExProd.selection$Volume, p=.8, list = FALSE)
training <- data[train_size,]
testing <- data[-train_size,]
ctrl <- trainControl(method = "repeatedcv", number = 10, repeats = 3)
```

## Random forest

```{r random forest model}
set.seed(956)
#Non-parametrical model: Random Forest
rfmodel <- train( Volume~., 
                  data = training, 
                  method = "rf",  
                  trControl = ctrl)

rfPredict <- predict(rfmodel,newdata = testing)
(rfResults <- postResample(rfPredict, testing$Volume))
```



1. Understand why is giving that errors
2. Linear mode to see its performance
3. Knn for regression

## Support vector machine

We are going to use the libraries caret and e1071:

```{r super vector machine model}
set.seed(956)
svmModel <- e1071::svm(Volume~. , 
                       data = training)

svmPredict <- predict(svmModel, newdata = testing)
(svmResults <- postResample(svmPredict, testing$Volume))
```

## XGBM methods in caret


```{r gradient boosted tree model ,eval=F}
set.seed(956)
gbmFit1 <- train(Volume ~ ., data = training, 
                 method = "gbm", 
                 trControl = ctrl,
                 verbose = FALSE)
training
```


```{r creation of the model}
# # RMSE        Rsquared         MAE 
# # 95.6428389  0.9726843 47.0752615
# # It changes everytime, as it is an iterative agorithm. BEEST PERFORMANCE
# 
# #####-------------------RESULTS-------------------####
# # Aplication of the model to the new products
# NwProd2$Volume <- predict(rfmodel, newdata = NwProd2)
# 
# #Anlaysis of the results.
# NwProd2 <- NwProd2[order (-NwProd2$Volume),]
# 
# # mix the two data frames to compare with the library (dplyr)
# TotalDF <- bind_rows(ex.Prod2,NwProd2,.id = "id")
# 
# #Visualization
# TotalDF.PC <- TotalDF[(TotalDF$ProductType.PC==1),]
# TotalDF.Laptop <- TotalDF[(TotalDF$ProductType.Laptop==1),]
# TotalDF.Netbook <- TotalDF[(TotalDF$ProductType.Netbook==1),]
# TotalDF.Smartphone <- TotalDF[(TotalDF$ProductType.Smartphone==1),]
# 
# ggplot(TotalDF.PC, aes(x = id, y = Volume))+
#   
#   plotPC <- ggplot(TotalDF.PC,aes(x = id, y = Volume)) + ggtitle("ProductType: PC") + geom_bar() + geom_text(aes(label=ProductNum),hjust=0, vjust=0)
# plotLaptop <- ggplot(TotalDF.Laptop,aes(x = id, y = Volume, color = id)) + ggtitle("ProductType: Laptop") + geom_point() + geom_text(aes(label=ProductNum),hjust=0, vjust=0)
# plotNetbook <- ggplot(TotalDF.Netbook,aes(x = id, y = Volume, color = id)) + ggtitle("ProductType: Netbook") + geom_point() + geom_text(aes(label=ProductNum),hjust=0, vjust=0)
# plotSmartphone <- ggplot(TotalDF.Smartphone,aes(x = id, y = Volume, color = id)) + ggtitle("ProductType: Smartphone") + geom_point() + geom_text(aes(label=ProductNum),hjust=0, vjust=0)
# library(gridExtra)
# grid.arrange(plotPC,plotLaptop,plotNetbook,plotSmartphone, ncol = 2)
# 
# # Let's take a look to all the relevant information of the new products
# TotalDF.PC<-select(TotalDF.PC,id,ProductNum,x4StarReviews,x1StarReviews,PositiveServiceReview,NegativeServiceReview,Recommendproduct,Volume)
# NPPC<-TotalDF.PC[TotalDF.PC$id%in%2,]
# TotalDF.Laptop<-select(TotalDF.Laptop,ProductNum,id,x4StarReviews,x1StarReviews,PositiveServiceReview,NegativeServiceReview,Recommendproduct,Volume)
# NPLp<-TotalDF.Laptop[TotalDF.Laptop$id%in%2,]
# TotalDF.Netbook<-select(TotalDF.Netbook,ProductNum,id,x4StarReviews,x1StarReviews,PositiveServiceReview,NegativeServiceReview,Recommendproduct,Volume)
# NPNb<-TotalDF.Netbook[TotalDF.Netbook$id%in%2,]
# TotalDF.Smartphone<-select(TotalDF.Smartphone,ProductNum,id,x4StarReviews,x1StarReviews,PositiveServiceReview,NegativeServiceReview,Recommendproduct,Volume)
# NPSp<-TotalDF.Smartphone[TotalDF.Smartphone$id%in%2,]
```

```{r}
n_df <- ExProd %>% 
  gather("x5StarReviews","x4StarReviews","x3StarReviews","x2StarReviews",
         "x1StarReviews","PositiveServiceReview","NegativeServiceReview", key = stars, value = value)
t
ggplot(n_df, aes(x = value, y = Volume, color = stars)) +
  geom_point(position = "jitter") + theme_bw() -> p

plotly::ggplotly(p)

```

